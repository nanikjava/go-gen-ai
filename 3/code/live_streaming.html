<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(120deg, #e0eafc 0%, #cfdef3 100%);
            margin: 0;
            padding: 0;
        }

        table {
            table-layout: fixed;
            width: 100%;
            border-collapse: separate;
            border-spacing: 24px 16px;
        }

        td {
            vertical-align: top;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0, 30, 90, 0.10);
            padding: 24px;
        }

        h3 {
            margin-top: 0;
            color: #2a4689;
            font-size: 1.15em;
        }

        p {
            color: #444;
            font-size: 1em;
            margin-bottom: 10px;
        }

        .audio-history {
            background: linear-gradient(135deg, #f0f6ff 0%, #e8f9fd 100%);
            padding: 24px;
            border-radius: 14px;
            box-shadow: 0 2px 8px rgba(44, 130, 201, 0.08);
        }

        button {
            background: linear-gradient(90deg, #5b86e5 0%, #36d1c4 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            margin: 8px 0;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(44, 130, 201, 0.12);
            transition: background 0.2s, transform 0.2s;
        }

        button:hover {
            background: linear-gradient(90deg, #36d1c4 0%, #5b86e5 100%);
            transform: translateY(-2px) scale(1.03);
        }

        hr {
            border: none;
            border-bottom: 1px solid #dce8ff;
            margin: 24px 0;
        }

        video {
            width: 100%;
            max-width: 320px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(44, 130, 201, 0.07);
            margin: 10px 0;
        }

        #output, #chat-history {
            background: #f7fbff;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(44,130,201,0.06);
            font-size: 0.97em;
        }

        @media (max-width: 1100px) {
            table, tr, td {
                display: block;
                width: 100%;
            }
            td {
                margin-bottom: 18px;
            }
            video {
                max-width: 100%;
            }
        }
    </style>

    <script>

        var audioDebug;
        (function () {

            var outputDiv;
            var inputDiv;
            var ws;
            var isRecording = false;
            var audioChunksReceived = [];
            var audioChunksSent = [];
            var chatHistory;
            var processor; // Audio processor.
            var inputTimer; // Timer for input button.

            var videoTimer = null; // Timer for Play Video button.
            var video;
            var videoCanvas = document.createElement('canvas');
            var videoCtx = videoCanvas.getContext('2d');
            var sampleRate = 24000;

            const audio = new Audio();
            var audioQueue = [];
            var isAudioPlaying = false;


            function print(message) {
                var d = document.createElement('div');
                d.textContent = message;
                outputDiv.appendChild(d);
                outputDiv.scroll(0, outputDiv.scrollHeight);
            }

            function printChatText(message, name) {
                const container = document.createElement('div');
                container.classList.add('vertical-container');
                if (name === 'Me') {
                    container.classList.add('align-right');
                }

                var dName = document.createElement('div');
                dName.textContent = name;
                container.append(dName);

                var dMessage = document.createElement('div');
                dMessage.textContent = message;
                container.append(dMessage);

                chatHistory.appendChild(container);
                chatHistory.scroll(0, chatHistory.scrollHeight);
            }

            function encodeAudio(audioChunks, sampleRate, bitDepth, numChannels) {
                var audioData = mergeUint8Array(audioChunks);

                const dataSize = audioData.length;
                const fileSize = dataSize + 36;
                const blockAlign = numChannels * bitDepth / 8;
                const byteRate = sampleRate * blockAlign;

                const buffer = new ArrayBuffer(44);
                const view = new DataView(buffer);

                function writeString(offset, string) {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                }

                writeString(0, 'RIFF');
                view.setUint32(4, fileSize, true);
                writeString(8, 'WAVE');
                writeString(12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, byteRate, true);
                view.setUint16(32, blockAlign, true);
                view.setUint16(34, bitDepth, true);
                writeString(36, 'data');
                view.setUint32(40, dataSize, true);

                let mergedData = mergeUint8Array([new Uint8Array(buffer), audioData]);

                return new Blob([mergedData.buffer], { type: 'audio/wav' });
            }

            function printChatAudio(audioBlob, message) {
                var d = document.createElement('div');
                d.classList.add('vertical-container');
                if (message === 'Me') {
                    d.classList.add('align-right');
                }
                const audioUrl = URL.createObjectURL(audioBlob);

                // Optionally, download the audio file.
                const link = document.createElement('a');
                link.href = audioUrl;
                link.download = 'recording.wav';
                link.innerText = message;
                d.appendChild(link);

                // Create an audio element to play the recording
                const audio = document.createElement('audio');
                audio.src = audioUrl;
                audio.controls = true;
                d.appendChild(audio);

                chatHistory.appendChild(d);
                chatHistory.scroll(0, chatHistory.scrollHeight);
            }

            function createContent(msg) {
                data = { 'clientContent': { 'turnComplete': true, 'turns': [{ 'parts': [{ 'text': msg }] }] } };
                return JSON.stringify(data);
            }

            function createImageContent(msg) {
                data = { 'media': { 'data': msg,  'mimeType': 'image/jpeg'  } };
                return JSON.stringify(data);
            }

            function createAudioContent(msg) {
                data = { 'media': { 'data': msg,  'mimeType': 'audio/pcm'  } };
                return JSON.stringify(data);
            }

            function mergeUint8Array(arrays) {
                const totalSize = arrays.reduce((acc, e) => acc + e.length, 0);
                const merged = new Uint8Array(totalSize);

                arrays.forEach((array, i, arrays) => {
                    const offset = arrays.slice(0, i).reduce((acc, e) => acc + e.length, 0);
                    merged.set(array, offset);
                });

                return merged;
            }

            function b64ToUint8Array(b64Data, contentType = '', sliceSize = 512) {
                const byteCharacters = atob(b64Data);
                const byteArrays = [];

                for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                    const slice = byteCharacters.slice(offset, offset + sliceSize);

                    const byteNumbers = new Array(slice.length);
                    for (let i = 0; i < slice.length; i++) {
                        byteNumbers[i] = slice.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    byteArrays.push(byteArray);
                }

                var res = mergeUint8Array(byteArrays);
                return res;
            }

            window.addEventListener('load', function (evt) {
                outputDiv = document.getElementById('output');
                chatHistory = document.getElementById('chat-history');
                video = document.getElementById('video')
                function openWs() {
                    if (ws) {
                        return false;
                    }
                    ws = new WebSocket('{{.}}');
                    ws.onopen = function (evt) {
                        print('OPEN');
                    }
                    ws.onclose = function (evt) {
                        print('CLOSE');
                        ws = null;
                    }
                    ws.onmessage = function (evt) {
                        data = JSON.parse(evt.data);
                        console.log(data);
                        if (!data.serverContent) return;
                        if (data.serverContent.turnComplete) {
                            if (audioChunksSent.length > 0) {
                                console.log(audioChunksSent.length);
                                printChatAudio(encodeAudio(audioChunksSent, sampleRate, 16, 1), 'Me');
                                audioChunksSent = [];
                            }
                            printChatAudio(encodeAudio(audioChunksReceived, sampleRate, 16, 1), 'Gemini 2.0')
                            audioChunksReceived = []
                            return;
                        }
                        if (!data.serverContent.modelTurn || !data.serverContent.modelTurn.parts || !data.serverContent.modelTurn.parts[0]) return;
                        if (data.serverContent.modelTurn.parts[0].inlineData) {
                            inlineData = data.serverContent.modelTurn.parts[0].inlineData;
                            print('RECEIVED: ' + typeof (inlineData) + inlineData.mimeType + inlineData.data)
                            if (inlineData.mimeType.startsWith('audio/pcm')) {
                                const audioData = b64ToUint8Array(inlineData.data);
                                audioQueue.push(audioData);
                                audioChunksReceived.push(audioData);
                                playNextChunk();
                            }
                            return;
                        }
                    }
                    ws.onerror = function (evt) {
                        print('ERROR: ' + evt.data);
                    }
                    return false;
                };
                openWs();

                document.getElementById('close').onclick = function (evt) {
                    if (!ws) {
                        return false;
                    }
                    ws.close();
                    return false;
                };

                document.getElementById('record').onclick = function (evt) {
                    if (isRecording) {
                        recordStop();
                    } else {
                        recordStart();
                    }
                }

                document.getElementById('playVideo').onclick = function () {
                    if (videoTimer != null) {
                        playVideoStop();
                    } else {
                        playVideoStart();
                    }
                }

            });

            function recordStop() {
                if (processor) {
                    processor.disconnect(); // Disconnect processor
                }
                isRecording = false;
                document.getElementById('record').textContent = 'Start Recording';
            }

            function recordStart() {
                recordAudio();
                isRecording = true;
                document.getElementById('record').textContent = 'Stop Recording';
            }

            function recordAudio() {
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    const audioContext = new AudioContext({ sampleRate: sampleRate });
                    const source = audioContext.createMediaStreamSource(stream);
                    processor = audioContext.createScriptProcessor(2048, 1, 1); // bufferSize, numInputChannels, numOutputChannels

                    processor.onaudioprocess = (e) => {
                        const inputData = e.inputBuffer.getChannelData(0); // Raw PCM data
                        const pcmData16 = convertFloat32ToInt16(inputData);

                        // Process or send pcmData16 via WebSocket
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            audioChunksSent.push(new Uint8Array(pcmData16.buffer))
                            const base64Data = arrayBufferToBase64(pcmData16.buffer);
                            ws.send(createAudioContent(base64Data));
                        }
                    };

                    source.connect(processor);
                    processor.connect(audioContext.destination); // Connect to output to hear audio during recording
                });
            }


            function arrayBufferToBase64(buffer) {
                let binary = '';
                const bytes = new Uint8Array(buffer);
                const len = bytes.byteLength;
                for (let i = 0; i < len; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return btoa(binary);
            }

            function convertFloat32ToInt16(float32Array) {
                const int16Array = new Int16Array(float32Array.length);
                for (let i = 0; i < float32Array.length; i++) {
                    int16Array[i] = Math.max(-32768, Math.min(32767, float32Array[i] * 32768)); // Scale and clamp
                }
                return int16Array;
            }

            function playNextChunk() {
                if (!isAudioPlaying && audioQueue.length > 0) {
                    isAudioPlaying = true;
                    const encodedAudio = encodeAudio(audioQueue, 24000, 16, 1);
                    audioQueue = [];
                    audio.src = URL.createObjectURL(encodedAudio);
                    audio.onended = function () {
                        isAudioPlaying = false;
                        playNextChunk();
                    }
                    audio.play();
                }
            }

            function playVideoStart() {
                if (videoTimer != null) {
                    playVideoStop();
                }
                video.play();
                videoTimer = setInterval(sendVideo, 1000);
            }

            function playVideoStop() {
                video.pause();
                clearInterval(videoTimer);
                videoTimer = null;
            }

            function sendVideo() {
                if (video.paused || video.ended) {
                    playVideoStop();
                    return;
                }

                videoCanvas.width = video.videoWidth;
                videoCanvas.height = video.videoHeight;
                videoCtx.drawImage(video, 0, 0);
                var encodedImage = videoCanvas.toDataURL('image/jpeg').split(';base64,')[1];

                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(createImageContent(encodedImage));
                }
            }
        })()

    </script>
</head>

<body>
    <table>
        <tr>
            <td width='20%'>
                <h3>Connection</h3>
                <p>Click to close the websocket connection.</p>
                <button id='close'>Close Connection</button>
                <hr />

                <h3>Audio In; Audio Out</h3>
                <p>Reload the page first to reset environment before trying this demo.</p>
                <button id='record'>Start Audio Conversation</button>
                <br /><br />

                <button id='playVideo'>Play Video in Audio Conversation</button>
                <video src='/proxyVideo' id='video' controls></video>
                <hr />

                <h3>Audio & Video In; Audio Out</h3>
                <p>Reload the page to reset environment before trying this demo.</p>
            </td>
            <td width='30%'>
                <h3>Output</h3>
                <div id='output' style='max-height: 40vh; overflow-y: auto;'></div>
            </td>
            <td width='50%'>
                <h3>Chat History</h3>
                <div id='chat-history' class='audio-history' style='max-height: 40vh; overflow-y: auto;'></div>
            </td>
        </tr>
    </table>
</body>

</html>
